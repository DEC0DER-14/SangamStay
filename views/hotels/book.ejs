<% layout('layouts/boilerplate') %>

<div class="container mt-5">
    <div class="row">
        <!-- Hotel Summary Sidebar -->
        <div class="col-md-4 order-md-2 order-1 mb-4">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Hotel Summary</h4>
                    <p class="card-text">
                        <strong><%= hotel.name %></strong><br>
                        <i class="fas fa-map-marker-alt"></i> <%= hotel.location %><br>
                        <i class="fas fa-map-pin"></i> <%= hotel.pincode %>
                    </p>
                    <p class="card-text">
                        <i class="fas fa-door-open"></i> <%= hotel.availableRooms %> rooms available
                    </p>
                    <% if(hotel.description) { %>
                        <p class="card-text"><%= hotel.description %></p>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="col-md-8 order-md-1 order-2">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Book <%= hotel.name %></h2>
                    <form action="/hotels/<%= hotel._id %>/book" method="POST" class="validated-form" novalidate>
                        <!-- Dates and Times -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="checkInDate">Check-in Date</label>
                                <input class="form-control" type="date" id="checkInDate" name="checkInDate" 
                                       value="<%= formData ? formData.checkInDate : new Date().toISOString().split('T')[0] %>" 
                                       min="<%= new Date().toISOString().split('T')[0] %>" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="checkOutDate">Check-out Date</label>
                                <input class="form-control" type="date" id="checkOutDate" name="checkOutDate" 
                                       value="<%= formData ? formData.checkOutDate : new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().split('T')[0] %>" 
                                       min="<%= new Date().toISOString().split('T')[0] %>" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="checkInTime">Check-in Time</label>
                                <input class="form-control" type="time" id="checkInTime" name="checkInTime" 
                                       value="<%= formData ? formData.checkInTime : '14:00' %>" required>
                                <small class="text-muted">Standard check-in time is 2:00 PM</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="checkOutTime">Check-out Time</label>
                                <input class="form-control" type="time" id="checkOutTime" name="checkOutTime" 
                                       value="<%= formData ? formData.checkOutTime : '11:00' %>" required>
                                <small class="text-muted">Standard check-out time is 11:00 AM</small>
                            </div>
                        </div>

                        <!-- Rooms and Guests -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="numberOfRooms">Number of Rooms</label>
                                <input class="form-control" type="number" id="numberOfRooms" name="numberOfRooms" 
                                       value="<%= formData ? formData.numberOfRooms : 1 %>" 
                                       min="1" max="<%= hotel.availableRooms %>" required>
                                <small class="text-muted"><%= hotel.availableRooms %> rooms available</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="numberOfGuests">Number of Guests</label>
                                <input class="form-control" type="number" id="numberOfGuests" name="numberOfGuests" 
                                       value="<%= formData ? formData.numberOfGuests : 1 %>" 
                                       min="1" required>
                                <small class="text-muted">Maximum 2 guests per room</small>
                            </div>
                        </div>

                        <!-- Guest Details -->
                        <div class="mb-3">
                            <h4>Guest Details</h4>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="guestName">Name</label>
                                    <input class="form-control" type="text" id="guestName" name="guestDetails[name]" 
                                           value="<%= formData && formData.guestDetails ? formData.guestDetails.name : '' %>" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="guestEmail">Email</label>
                                    <input class="form-control" type="email" id="guestEmail" name="guestDetails[email]" 
                                           value="<%= formData && formData.guestDetails ? formData.guestDetails.email : '' %>" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="guestPhone">Phone</label>
                                    <input class="form-control" type="tel" id="guestPhone" name="guestDetails[phone]" 
                                           pattern="[0-9]{10}" title="Please enter a valid 10-digit phone number"
                                           value="<%= formData && formData.guestDetails ? formData.guestDetails.phone : '' %>" required>
                                </div>
                            </div>
                        </div>

                        <!-- Special Requests -->
                        <div class="mb-3">
                            <label class="form-label" for="specialRequests">Special Requests</label>
                            <textarea class="form-control" id="specialRequests" name="specialRequests" rows="3"><%= formData ? formData.specialRequests : '' %></textarea>
                        </div>

                        <!-- Price Summary -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Price Summary</h5>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Price per night:</span>
                                    <span>₹<%= hotel.price %></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Number of rooms:</span>
                                    <span id="summaryRooms">1</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Number of nights:</span>
                                    <span id="summaryNights">1</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Total Amount:</span>
                                    <span id="totalAmount">₹<%= hotel.price %></span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Proceed to Payment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const pricePerNight = parseInt('<%= hotel.price %>');
    const numberOfRoomsInput = document.getElementById('numberOfRooms');
    const numberOfGuestsInput = document.getElementById('numberOfGuests');
    const checkInDateInput = document.getElementById('checkInDate');
    const checkOutDateInput = document.getElementById('checkOutDate');
    const summaryRooms = document.getElementById('summaryRooms');
    const summaryNights = document.getElementById('summaryNights');
    const totalAmountDisplay = document.getElementById('totalAmount');

    function updatePriceDetails() {
        const numberOfRooms = Number(numberOfRoomsInput.value) || 1;
        const checkIn = new Date(checkInDateInput.value);
        const checkOut = new Date(checkOutDateInput.value);
        const numberOfNights = Math.max(1, Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24)));

        summaryRooms.textContent = numberOfRooms;
        summaryNights.textContent = numberOfNights;
        totalAmountDisplay.textContent = `₹${pricePerNight * numberOfRooms * numberOfNights}`;
    }

    [numberOfRoomsInput, checkInDateInput, checkOutDateInput].forEach(input => {
        input.addEventListener('change', updatePriceDetails);
    });

    // Add validation before form submission
    document.querySelector('.validated-form').addEventListener('submit', function(e) {
        const numberOfRooms = Number(numberOfRoomsInput.value) || 1;
        const numberOfGuests = Number(numberOfGuestsInput.value) || 1;
        const guestsPerRoom = numberOfGuests / numberOfRooms;

        if (guestsPerRoom > 2) {
            e.preventDefault();
            alert('Maximum 2 guests allowed per room. Please adjust your booking.');
        }

        const checkIn = new Date(checkInDateInput.value);
        const checkOut = new Date(checkOutDateInput.value);
        if (checkOut <= checkIn) {
            e.preventDefault();
            alert('Check-out date must be after check-in date.');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Set default dates if not already set
        if (!checkInDateInput.value) {
            const today = new Date();
            checkInDateInput.value = today.toISOString().split('T')[0];
        }
        if (!checkOutDateInput.value) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            checkOutDateInput.value = tomorrow.toISOString().split('T')[0];
        }
        
        // Initial price calculation
        updatePriceDetails();
    });
</script>

<style>
.container {
    padding: 1rem;
}

@media (max-width: 768px) {
    .container {
        padding: 0.5rem;
    }

    .card {
        margin: 0.5rem;
        border-radius: 20px;
    }

    .form-control {
        border-radius: 12px;
    }

    .btn-primary {
        width: 100%;
        border-radius: 20px;
        margin-top: 1rem;
    }

    .row {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
    }

    .col-md-6 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
}

.card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    margin-bottom: 1.5rem;
}

.card-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1.5rem;
}

@media (max-width: 576px) {
    .container {
        padding: 0.5rem;
    }

    .card {
        margin: 0.5rem;
        border-radius: 20px;
    }

    .card-title {
        font-size: 1.3rem;
        margin-bottom: 1rem;
    }

    .form-control {
        border-radius: 12px;
        font-size: 1rem;
    }

    .btn-primary {
        width: 100%;
        border-radius: 20px;
        padding: 0.8rem;
        margin-top: 1rem;
    }
}

.form-label {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.form-control {
    padding: 0.7rem 1rem;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    font-size: 1rem;
}

.form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.text-muted {
    font-size: 0.85rem;
}

.btn-primary {
    background: #2c3e50;
    border: none;
    padding: 0.8rem 2rem;
    border-radius: 20px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: #34495e;
    transform: translateY(-2px);
}
</style> 