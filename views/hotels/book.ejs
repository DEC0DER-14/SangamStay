<% layout('layouts/boilerplate') %>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Book <%= hotel.name %></h2>
                    <form action="/hotels/<%= hotel._id %>/book" method="POST" class="validated-form" novalidate>
                        <!-- Dates and Times -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="checkInDate">Check-in Date</label>
                                <input class="form-control" type="date" id="checkInDate" name="checkInDate" 
                                       value="<%= formData ? formData.checkInDate : new Date().toISOString().split('T')[0] %>" 
                                       min="<%= new Date().toISOString().split('T')[0] %>" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="checkOutDate">Check-out Date</label>
                                <input class="form-control" type="date" id="checkOutDate" name="checkOutDate" 
                                       value="<%= formData ? formData.checkOutDate : new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().split('T')[0] %>" 
                                       min="<%= new Date().toISOString().split('T')[0] %>" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="checkInTime">Check-in Time</label>
                                <input class="form-control" type="time" id="checkInTime" name="checkInTime" 
                                       value="14:00" required>
                                <small class="text-muted">Standard check-in time is 2:00 PM</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="checkOutTime">Check-out Time</label>
                                <input class="form-control" type="time" id="checkOutTime" name="checkOutTime" 
                                       value="11:00" required>
                                <small class="text-muted">Standard check-out time is 11:00 AM</small>
                            </div>
                        </div>

                        <!-- Room Selection -->
                        <div class="mb-3">
                            <label class="form-label" for="roomType">Select Room Type</label>
                            <select class="form-select" id="roomType" name="roomType" required>
                                <option value="">Select a room type...</option>
                                <% hotel.rooms.forEach(room => { %>
                                    <option value="<%= room._id %>" 
                                            data-price="<%= room.pricePerNight %>"
                                            data-capacity="<%= room.capacity %>"
                                            <%= formData && formData.roomType === room._id.toString() ? 'selected' : '' %>>
                                        <%= room.roomType %> - ₹<%= room.pricePerNight %> per night
                                    </option>
                                <% }) %>
                            </select>
                        </div>

                        <!-- Guest Information -->
                        <div class="mb-3">
                            <h4>Guest Details</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label" for="guestName">Guest Name</label>
                                    <input class="form-control" type="text" id="guestName" 
                                           name="guestDetails[name]" 
                                           value="<%= formData ? formData.guestDetails.name : currentUser.username %>" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="guestPhone">Phone Number</label>
                                    <input class="form-control" type="tel" id="guestPhone" 
                                           name="guestDetails[phone]" 
                                           value="<%= formData ? formData.guestDetails.phone : '' %>" required>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label" for="guestEmail">Email</label>
                                <input class="form-control" type="email" id="guestEmail" 
                                       name="guestDetails[email]" 
                                       value="<%= formData ? formData.guestDetails.email : currentUser.email %>" required>
                            </div>
                        </div>

                        <!-- Room and Guest Count -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="numberOfRooms">Number of Rooms</label>
                                <input class="form-control" type="number" id="numberOfRooms" 
                                       name="numberOfRooms" min="1" 
                                       value="<%= formData ? formData.numberOfRooms : 1 %>" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="numberOfGuests">Number of Guests</label>
                                <input class="form-control" type="number" id="numberOfGuests" 
                                       name="numberOfGuests" min="1" 
                                       value="<%= formData ? formData.numberOfGuests : 1 %>" required>
                                <small id="guestCapacityMessage" class="text-muted">Maximum 2 guests per room</small>
                            </div>
                        </div>

                        <!-- Special Requests -->
                        <div class="mb-3">
                            <label class="form-label" for="specialRequests">Special Requests</label>
                            <textarea class="form-control" id="specialRequests" name="specialRequests" 
                                      rows="3" placeholder="Any special requests or preferences?"><%= formData ? formData.specialRequests : '' %></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">Confirm Booking</button>
                        <a href="/hotels/<%= hotel._id %>" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>

        <!-- Booking Summary Card -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Booking Summary</h5>
                    <div class="booking-details">
                        <p><strong>Room Rate:</strong> ₹<span id="roomRate">0</span> per night</p>
                        <p><strong>Number of Rooms:</strong> <span id="roomCount">1</span></p>
                        <p><strong>Number of Nights:</strong> <span id="nightCount">0</span></p>
                        <hr>
                        <p class="h5"><strong>Total Amount:</strong> ₹<span id="totalAmount">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const checkInDateInput = document.getElementById('checkInDate');
    const checkOutDateInput = document.getElementById('checkOutDate');
    const roomTypeSelect = document.getElementById('roomType');
    const numberOfRoomsInput = document.getElementById('numberOfRooms');
    const numberOfGuestsInput = document.getElementById('numberOfGuests');
    const roomRateSpan = document.getElementById('roomRate');
    const roomCountSpan = document.getElementById('roomCount');
    const nightCountSpan = document.getElementById('nightCount');
    const totalAmountSpan = document.getElementById('totalAmount');
    const guestCapacityMessage = document.getElementById('guestCapacityMessage');

    function updatePriceDetails() {
        const selectedOption = roomTypeSelect.options[roomTypeSelect.selectedIndex];
        const pricePerNight = selectedOption ? Number(selectedOption.dataset.price) : 0;
        const numberOfRooms = Number(numberOfRoomsInput.value) || 1;
        const capacity = selectedOption ? Number(selectedOption.dataset.capacity) : 0;

        // Calculate number of nights
        const checkInDate = new Date(checkInDateInput.value);
        const checkOutDate = new Date(checkOutDateInput.value);
        const numberOfNights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24)) || 0;

        // Update display values, replacing NaN with 0
        roomRateSpan.textContent = pricePerNight || 0;
        roomCountSpan.textContent = numberOfRooms;
        nightCountSpan.textContent = numberOfNights;
        
        // Calculate total amount, ensuring we don't display NaN
        const total = (pricePerNight * numberOfRooms * numberOfNights) || 0;
        totalAmountSpan.textContent = total;

        // Update guest capacity message
        const currentGuests = Number(numberOfGuestsInput.value) || 1;
        const maxGuests = 2 * numberOfRooms;
        if (currentGuests > maxGuests) {
            guestCapacityMessage.textContent = `Maximum ${maxGuests} guests allowed for ${numberOfRooms} room(s) (2 guests per room)`;
            guestCapacityMessage.classList.add('text-danger');
        } else {
            guestCapacityMessage.textContent = `Maximum capacity: ${maxGuests} guests (2 guests per room)`;
            guestCapacityMessage.classList.remove('text-danger');
        }
    }

    // Add event listeners
    [checkInDateInput, checkOutDateInput, roomTypeSelect, numberOfRoomsInput, numberOfGuestsInput].forEach(element => {
        element.addEventListener('change', updatePriceDetails);
    });

    // Set minimum check-out date based on check-in date
    checkInDateInput.addEventListener('change', function() {
        checkOutDateInput.min = this.value;
        if (checkOutDateInput.value && checkOutDateInput.value < this.value) {
            checkOutDateInput.value = this.value;
        }
    });

    // Add validation before form submission
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        const numberOfRooms = Number(numberOfRoomsInput.value) || 1;
        const numberOfGuests = Number(numberOfGuestsInput.value) || 1;
        const guestsPerRoom = numberOfGuests / numberOfRooms;

        if (guestsPerRoom > 2) {
            e.preventDefault();
            alert('Maximum 2 guests allowed per room. Please adjust your booking.');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Set default dates
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        document.getElementById('checkInDate').value = today.toISOString().split('T')[0];
        document.getElementById('checkOutDate').value = tomorrow.toISOString().split('T')[0];
        
        // Initial price calculation
        updatePriceDetails();
    });
</script>

<style>
.container {
    padding: 1rem;
}

@media (max-width: 768px) {
    .container {
        padding: 0.5rem;
    }
}

.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    margin-bottom: 1.5rem;
}

.card-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1.5rem;
}

@media (max-width: 576px) {
    .card-title {
        font-size: 1.3rem;
        margin-bottom: 1rem;
    }
}

.form-label {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.form-control {
    padding: 0.7rem 1rem;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    font-size: 1rem;
}

.form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.text-muted {
    font-size: 0.85rem;
}

.btn {
    padding: 0.7rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #2c3e50;
    border: none;
}

.btn-primary:hover {
    background: #34495e;
    transform: translateY(-2px);
}

.booking-details {
    background: #f8f9fa;
    padding: 1.2rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.booking-details p {
    margin-bottom: 0.8rem;
    font-size: 0.95rem;
}

.booking-details .h5 {
    color: #2c3e50;
    margin-top: 1rem;
    font-weight: 600;
}

@media (max-width: 768px) {
    .row > [class*="col-"] {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    .form-control, .btn {
        font-size: 0.95rem;
        padding: 0.6rem 1rem;
    }

    .booking-details {
        padding: 1rem;
        margin-top: 0.5rem;
    }

    .booking-details p {
        font-size: 0.9rem;
        margin-bottom: 0.6rem;
    }

    .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}

@media (max-width: 576px) {
    .card-body {
        padding: 1rem;
    }

    .row {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
    }

    .form-label {
        font-size: 0.9rem;
    }

    .text-muted {
        font-size: 0.8rem;
    }
}
</style> 