<% layout('layouts/boilerplate') %>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Book <%= hotel.name %></h2>
                    <form action="/hotels/<%= hotel._id %>/book" method="POST" class="validated-form" novalidate>
                        <!-- Dates and Times -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="checkInDate">Check-in Date</label>
                                <input class="form-control" type="date" id="checkInDate" name="checkInDate" 
                                       min="<%= new Date().toISOString().split('T')[0] %>" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="checkOutDate">Check-out Date</label>
                                <input class="form-control" type="date" id="checkOutDate" name="checkOutDate" 
                                       min="<%= new Date().toISOString().split('T')[0] %>" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="checkInTime">Check-in Time</label>
                                <input class="form-control" type="time" id="checkInTime" name="checkInTime" 
                                       value="14:00" required>
                                <small class="text-muted">Standard check-in time is 2:00 PM</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="checkOutTime">Check-out Time</label>
                                <input class="form-control" type="time" id="checkOutTime" name="checkOutTime" 
                                       value="11:00" required>
                                <small class="text-muted">Standard check-out time is 11:00 AM</small>
                            </div>
                        </div>

                        <!-- Room Selection -->
                        <div class="mb-3">
                            <label class="form-label" for="roomType">Select Room Type</label>
                            <select class="form-select" id="roomType" name="roomType" required>
                                <option value="">Select a room type...</option>
                                <% hotel.rooms.forEach(room => { %>
                                    <option value="<%= room._id %>" 
                                            data-price="<%= room.pricePerNight %>"
                                            data-capacity="<%= room.capacity %>">
                                        <%= room.roomType %> - ₹<%= room.pricePerNight %> per night
                                    </option>
                                <% }) %>
                            </select>
                        </div>

                        <!-- Guest Information -->
                        <div class="mb-3">
                            <h4>Guest Details</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label" for="guestName">Guest Name</label>
                                    <input class="form-control" type="text" id="guestName" 
                                           name="guestDetails[name]" value="<%= currentUser.username %>" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="guestPhone">Phone Number</label>
                                    <input class="form-control" type="tel" id="guestPhone" 
                                           name="guestDetails[phone]" required>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label" for="guestEmail">Email</label>
                                <input class="form-control" type="email" id="guestEmail" 
                                       name="guestDetails[email]" value="<%= currentUser.email %>" required>
                            </div>
                        </div>

                        <!-- Room and Guest Count -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="numberOfRooms">Number of Rooms</label>
                                <input class="form-control" type="number" id="numberOfRooms" 
                                       name="numberOfRooms" min="1" value="1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="numberOfGuests">Number of Guests</label>
                                <input class="form-control" type="number" id="numberOfGuests" 
                                       name="numberOfGuests" min="1" value="1" required>
                                <small id="guestCapacityMessage" class="text-muted"></small>
                            </div>
                        </div>

                        <!-- Special Requests -->
                        <div class="mb-3">
                            <label class="form-label" for="specialRequests">Special Requests</label>
                            <textarea class="form-control" id="specialRequests" name="specialRequests" 
                                      rows="3" placeholder="Any special requests or preferences?"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">Confirm Booking</button>
                        <a href="/hotels/<%= hotel._id %>" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>

        <!-- Booking Summary Card -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Booking Summary</h5>
                    <div class="booking-details">
                        <p><strong>Room Rate:</strong> ₹<span id="roomRate">0</span> per night</p>
                        <p><strong>Number of Rooms:</strong> <span id="roomCount">1</span></p>
                        <p><strong>Number of Nights:</strong> <span id="nightCount">0</span></p>
                        <hr>
                        <p class="h5"><strong>Total Amount:</strong> ₹<span id="totalAmount">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const checkInDateInput = document.getElementById('checkInDate');
    const checkOutDateInput = document.getElementById('checkOutDate');
    const roomTypeSelect = document.getElementById('roomType');
    const numberOfRoomsInput = document.getElementById('numberOfRooms');
    const numberOfGuestsInput = document.getElementById('numberOfGuests');
    const roomRateSpan = document.getElementById('roomRate');
    const roomCountSpan = document.getElementById('roomCount');
    const nightCountSpan = document.getElementById('nightCount');
    const totalAmountSpan = document.getElementById('totalAmount');
    const guestCapacityMessage = document.getElementById('guestCapacityMessage');

    function updatePriceDetails() {
        const selectedOption = roomTypeSelect.options[roomTypeSelect.selectedIndex];
        const pricePerNight = selectedOption ? Number(selectedOption.dataset.price) : 0;
        const numberOfRooms = Number(numberOfRoomsInput.value);
        const capacity = selectedOption ? Number(selectedOption.dataset.capacity) : 0;

        // Calculate number of nights
        const checkInDate = new Date(checkInDateInput.value);
        const checkOutDate = new Date(checkOutDateInput.value);
        const numberOfNights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

        roomRateSpan.textContent = pricePerNight;
        roomCountSpan.textContent = numberOfRooms;
        nightCountSpan.textContent = numberOfNights > 0 ? numberOfNights : 0;
        totalAmountSpan.textContent = numberOfNights > 0 ? pricePerNight * numberOfRooms * numberOfNights : 0;

        // Update guest capacity message
        const maxGuests = capacity * numberOfRooms;
        const currentGuests = Number(numberOfGuestsInput.value);
        if (currentGuests > maxGuests) {
            guestCapacityMessage.textContent = `Maximum ${maxGuests} guests allowed for ${numberOfRooms} room(s)`;
            guestCapacityMessage.classList.add('text-danger');
        } else {
            guestCapacityMessage.textContent = `Maximum capacity: ${maxGuests} guests`;
            guestCapacityMessage.classList.remove('text-danger');
        }
    }

    // Add event listeners
    [checkInDateInput, checkOutDateInput, roomTypeSelect, numberOfRoomsInput, numberOfGuestsInput].forEach(element => {
        element.addEventListener('change', updatePriceDetails);
    });

    // Set minimum check-out date based on check-in date
    checkInDateInput.addEventListener('change', function() {
        checkOutDateInput.min = this.value;
        if (checkOutDateInput.value && checkOutDateInput.value < this.value) {
            checkOutDateInput.value = this.value;
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Set default dates
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        document.getElementById('checkInDate').value = today.toISOString().split('T')[0];
        document.getElementById('checkOutDate').value = tomorrow.toISOString().split('T')[0];
        
        // Initial price calculation
        updatePriceDetails();
    });
</script> 